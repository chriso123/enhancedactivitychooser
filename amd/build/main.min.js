define(["jquery","core/str","core/modal_factory","core/templates","core/ajax"],function(a,b,c,d,e){return{init:function(){var f,g=0;a("body").addClass("activitychooser-enabled");var h=function(a){return e.call([{methodname:"local_activitychooser_toggle_starred",args:{activityid:a}}])[0].then(function(){return i(g)}).then(function(a){return d.render("local_activitychooser/modulechooser",a)}).then(function(a){f.setBody(a)})},i=function(b){var c=document.body.className.match(/course-(\d+)/)[1];return e.call([{methodname:"local_activitychooser_get_activites",args:{sectionnum:b,course:c}}])[0].then(function(b){var c=function(a,b){var c=[],d=[];return a.forEach(function(a){d.length<b?d.push(a):(c.push(d),d=[a])}),d.length>0&&c.push(d),c},d=c(b.all,2),e=c(b.recommended,2),f=c(b.starred,4),g=!!a("#collapsed-all").hasClass("show");return{allRows:d,recommendedRows:e,starredRows:f,allExpandable:e.length||f.length,allExpanded:g}})};b.get_string("addactivity","local_activitychooser").then(function(b){var d='<button class="alternative-modchooser btn link"><i class="icon fa fa-plus fa-fw "></i>'+b+"</button>";a(".section-modchooser-link").parent().append(d);var e=b,f="<div></div>";return c.create({type:c.types.DEFAULT,title:e,body:f,large:!0})}).then(function(b){f=b,a(".alternative-modchooser").click(function(){var c=a(this).closest("li.section").attr("id").split("-")[1];b.show(),g=c,i(c).then(function(a){var c=d.render("local_activitychooser/modulechooser",a);b.setBody(c)})})}),a("body").on("click",".activitychooser-modal-body .row .toggle-favourite",function(){var b=a(this).data("id");a(this).addClass("spinning"),h(b)}),a("body").on("click",".activitychooser-modal-body .row .help-text",function(){a(this).toggleClass("help-visible")})}}});